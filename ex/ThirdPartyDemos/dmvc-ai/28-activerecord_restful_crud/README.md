# 28-activerecord_restful_crud - RESTful CRUD with ActiveRecord Pattern

**Port of**: DMVCFramework `samples/activerecord_restful_crud`
**Difficulty**: Intermediate
**Demonstrates**: ORM-based CRUD operations, SQLite persistence, RESTful API design

## Overview

This sample demonstrates how to implement a complete RESTful CRUD API using mORMot2's ORM (Object-Relational Mapping) capabilities, which is the equivalent of DMVC's ActiveRecord pattern. The sample includes three entities (People, Articles, Phones) with full Create, Read, Update, Delete operations.

## DMVC → mORMot2 Mapping

| DMVC Concept | mORMot2 Equivalent | Description |
|--------------|-------------------|-------------|
| `TMVCActiveRecord` | `TOrm` | Base class for ORM entities |
| `MVCTable` attribute | Class registration | Table mapping |
| `MVCTableField` attribute | Published properties | Field mapping |
| `TMVCActiveRecord.Store` | `Server.Orm.Add()` | Insert record |
| `TMVCActiveRecord.Update` | `Server.Orm.Update()` | Update record |
| `TMVCActiveRecord.Delete` | `Server.Orm.Delete()` | Delete record |
| `TMVCActiveRecord.Load` | `TOrm.Create(Orm, ID)` | Load by ID |
| Database connection | `TRestServerDB` | Database-backed REST server |
| Controller methods | Service interface methods | API endpoints |

## Implementation Details

### Entity Definition

```pascal
// DMVC version
[MVCTable('people')]
[MVCEntityActions([eaCreate, eaRetrieve, eaUpdate, eaDelete])]
TPerson = class(TMVCActiveRecord)
  [MVCTableField('id', [foPrimaryKey, foAutoGenerated])]
  fID: Int64;
  ...
end;

// mORMot2 version
TPersonOrm = class(TOrm)
private
  fLastName: RawUtf8;
  fFirstName: RawUtf8;
published
  property LastName: RawUtf8 read fLastName write fLastName;
  property FirstName: RawUtf8 read fFirstName write fFirstName;
end;
```

### CRUD Operations

```pascal
// Create
person := TPersonOrm.Create;
person.FirstName := 'John';
person.LastName := 'Doe';
id := Server.Orm.Add(person, true);

// Read
person := TPersonOrm.Create(Server.Orm, id);

// Update
person.FirstName := 'Jane';
Server.Orm.Update(person);

// Delete
Server.Orm.Delete(TPersonOrm, id);
```

### Service Interface

The API is exposed through interface-based services:

```pascal
IActiveRecordApi = interface(IInvokable)
  function GetPerson(id: TID): Variant;
  function GetAllPeople: TVariantDynArray;
  function CreatePerson(const lastName, firstName, note: RawUtf8;
    dob: TDateTime; isMale: Boolean): TID;
  function UpdatePerson(id: TID; ...): Boolean;
  function DeletePerson(id: TID): Boolean;
end;
```

## Building

```bash
# Using delphi-compiler.exe
/mnt/w/Agentic-Coding/Tools/delphi-compiler.exe 28-activerecord_restful_crud.dproj

# Or using Delphi IDE
# Open 28-activerecord_restful_crud.dproj
# Build > Compile
```

## Usage

1. **Start the server**:
   ```bash
   28-activerecord_restful_crud.exe
   ```

2. **Test the endpoints**:

   ```bash
   # Get all people
   curl http://localhost:8080/activerecord/ActiveRecordApi/GetAllPeople

   # Get person by ID
   curl http://localhost:8080/activerecord/ActiveRecordApi/GetPerson?id=1

   # Create new person (JSON body)
   curl -X POST http://localhost:8080/activerecord/ActiveRecordApi/CreatePerson \
     -H "Content-Type: application/json" \
     -d '{"lastName":"Brown","firstName":"Charlie","note":"Test","dob":"1995-03-20","isMale":true}'

   # Update person
   curl -X POST http://localhost:8080/activerecord/ActiveRecordApi/UpdatePerson \
     -H "Content-Type: application/json" \
     -d '{"id":1,"lastName":"Doe","firstName":"John","note":"Updated","dob":"1990-05-15","isMale":true}'

   # Delete person
   curl -X DELETE http://localhost:8080/activerecord/ActiveRecordApi/DeletePerson?id=1

   # Get all articles
   curl http://localhost:8080/activerecord/ActiveRecordApi/GetAllArticles

   # Get phones for person
   curl http://localhost:8080/activerecord/ActiveRecordApi/GetPhonesByPerson?personId=1
   ```

3. **Database**:
   - SQLite database created automatically as `activerecord.db3`
   - Sample data is populated on first run
   - Database persists between runs

## Key Differences from DMVC

| Aspect | DMVC | mORMot2 |
|--------|------|---------|
| **Pattern** | Controller-based MVC | Interface-based services |
| **ORM** | ActiveRecord pattern | Data Mapper pattern |
| **Attributes** | Extensive use of attributes | Minimal attributes, convention-based |
| **Database** | Requires FireDAC setup | Built-in SQLite support |
| **Routing** | Attribute-based routing | Service method = endpoint |
| **Validation** | OnValidation override | Custom validation in service |
| **Relationships** | Has-many via properties | Foreign keys + manual joins |

## Features Demonstrated

1. **ORM Entity Definition**
   - TOrm descendants for domain objects
   - Published properties for persistence
   - Automatic ID generation

2. **CRUD Operations**
   - Create with Add()
   - Read with Retrieve() or constructor
   - Update with Update()
   - Delete with Delete()

3. **RESTful API**
   - Interface-based service definition
   - Automatic JSON serialization
   - Method-based routing

4. **Database Persistence**
   - SQLite backend (can use other databases)
   - Auto-create tables
   - Sample data initialization

5. **Foreign Key Relationships**
   - TPhoneOrm has PersonID foreign key
   - Query by foreign key with RetrieveListObjArray

## Architecture

```
Client Request
    ↓
HTTP Server (TRestHttpServer)
    ↓
REST Server (TRestServerDB)
    ↓
Service Implementation (TActiveRecordApiService)
    ↓
ORM Layer (IRestOrm)
    ↓
SQLite Database (activerecord.db3)
```

## See Also

- **Sample 06** (articles_crud_server) - Basic CRUD without ORM
- **Sample 29** (activerecord_showcase) - More ActiveRecord features
- **Sample 30** (simple_api_using_mvcactiverecord) - Simplified ActiveRecord API
- **Sample 05** (datasets) - Dataset-based approach

## Notes

- **Performance**: mORMot2 ORM is highly optimized with caching and batching
- **Flexibility**: Can use different databases (SQLite, PostgreSQL, MSSQL, etc.)
- **Type Safety**: Interface-based services are type-safe at compile time
- **No Attributes**: mORMot2 uses less attributes than DMVC, relying on conventions
- **Validation**: Add custom validation in service layer before ORM operations
- **Transactions**: Use Server.Orm.TransactionBegin/Commit for multi-operation transactions

---

**Created**: 2025-12-20
**mORMot2 Version**: Latest
**DMVCFramework Equivalent**: activerecord_restful_crud
